 # Домашнее задание №8

Что было сделано:
* в предоставленный сервис было добавлено разноуровневое логирование;
* написан middleware RequestID, генерирующий uuid для каждого запроса и прокидывающий его в контекст;
* написан middleware AccessLog логирущий результаты запроса
* написан middleware Recover перехватывающий панику и логирующий возникшую ошибку
* были подняты prometheus и graphana;
* созданы и замониторины метрики в нашем сервисе для подсчета количества хитов на каждый эндпоинт с распределением по статусу ответа; для отслеживания таймингов на каждый эндпоинт; для посчета походов во внешние сервисы с распределением по статусу; для отслеживания таймингов на каждый поход в сервисы;
* создан dashboard с графиками в graphana;
* на основе всех выполненных выше действий, были выявлены проблемные места о которых подробно описано ниже;
* все сервера подняты на удаленной машине.

### Выявленные проблемные моменты:
* Обработчик получения треда был зарегистрирован на неправильный путь "/thread/:id", поскольку внутри хэндлера идентификатор треда достается из контекста по ключу "tid". То есть внешнему сервису всегда отправляется запрос на получение треда с пустым идентификатором. Этот момент поправил

* При исследовании графиков с хитами на каждый эндпоинт было обнаружено, что возвращается достаточно большое количество ответов со статусом 401
![401_server](https://sun9-68.userapi.com/impg/MVsbfvzm-p7IuA0A0Ney6dtTilCcgV6nssfHxQ/KO8GPDA9BoA.jpg?size=1920x844&quality=95&sign=9e47e8fa8b2ce6a5ff6c3455b1329403&type=album)
При этом, при исследовании графиков со статусами ответов внешних сервисов видно, что при походе в сервис авторизации по url http://vk-golang.ru:17000/int/CheckSession частенько возвращаются 500.
![500_auth](https://sun9-39.userapi.com/impg/P5-o9LkqkhvKNADJ9ih8HpjWBikBMnh6QjFEIw/Io9-4GJHUOU.jpg?size=1920x780&quality=95&sign=ee4e488cb7cd7a59c9fb43d1bb4df9d4&type=album)
При этом пользователю не понятно, происходит внутренняя ошибка сервера или же просто неверные авторизационные данные, поскольку auth middleware на все что не 200 возвращает 401. Я добавил более подробную обработку ошибок похода в сервис авторизации в middleware, однако ответственный за сервис авторизации также должен устранить возникновение 500.

* При исследовании графиков с хитами на каждый эндпоинт было обнаружено, что после определенного времени работы сервера под нагрузкой, запросы, которые ранее не возвращали ошибок начинают возвращать 500 (получение треда "GET /thread/:tid" и создание коммента "POST /thread/:tid/comment"). (Исследование проводилось до исправления обработки ошибок в auth middleware. Теперь эти запросы тоже бывает возвращают 500, поскольку сервис авторизации не всегда успешно отвечает)
![server_unexpected_500](https://sun9-1.userapi.com/impg/coJw9jV3MJg3-p7wLnXps7vryhdwLwMMmHKufw/cmBriptdtUg.jpg?size=1920x816&quality=95&sign=266043b4be8d1bd74e670ea251d043b2&type=album)
При этом, внешние сервисы не возвращает каких-либо ошибок на данные операции.
![services_no_500](https://sun9-79.userapi.com/impg/monA-HYGKBYsedHu4dpED8KUY0-wzNuPOkMScQ/nK8DK21_hVI.jpg?size=1919x793&quality=95&sign=33272bd8a2d7ff0a4aa1828fcd83fffa&type=album)
Проблема заключается в том, что при отправке http запросов во внешние сервисы не закрывается тело ответа. Из-за этого происходит утечка ресурсов и при достижении определенного момента дальнейший вызов http.DefaultClient.Do(req) падает с ошибкой. Проблема была устранена.

* Было определены места, где сервисы возвращают невалидные ответы (500):
  - сервис авторизации: проверка сессии: ("GET http://vk-golang.ru:17000/int/CheckSession")
  - сервис тредов: создание треда ("POST http://vk-golang.ru:15000/thread")
  - сервис комментов: лайк коммента: ("POST http://vk-golang.ru:16000/comment/like")
![services_all_500](https://sun9-6.userapi.com/impg/Dyn44kHzXhyw7BkHTtTj_O7s4FMiF4blJVat4A/10M1O5XoKko.jpg?size=1919x821&quality=95&sign=c5f87326a14c607798c8ebc8a08dd01f&type=album)

* Небольшое примечание: скриншоты выше с метриками внешних сервисов имеют лейбл url. В итоговой версии этот лейбл был разбит на два других host и handler для более удобной фильтрации метрик. Скриншоты не переделывал, поскольку пришлось бы откатывать некоторые исправления в коде.

* Для анализа задержек было построено несколько графиков:
![services_all_latences](https://sun9-38.userapi.com/impg/PzgsWRd89MNR2VhlFQxUOWO5I8SyrckBbh60eQ/h17m0JKNYiQ.jpg?size=1917x537&quality=95&sign=57b68b9451bc1175aff28d83ddc66419&type=album)
На данных графиках видно, что все сервисы по таймингам не укладываются в SLA. Задержка очень большая у всех сервисов. Сервис комментов показывает себя лучше всего: хэндлер лайка коммента попадает в требуемый диапазон в 50-85% случаев. Также иногда имеет требуемую задержку хэндлер создания треда (до 2.5% от всех запросов).
---
### Итоговый внешний вид дашборда:
![dashboard_1](https://sun9-43.userapi.com/impg/vIAQiti0FRibeLtQH5dyT6PJcqiH_Flgb4kWJA/xpwssSCtDJ8.jpg?size=1920x1080&quality=95&sign=df1c6cc08f0c90a1e4df89020a506b68&type=album)

![dashboard_2](https://sun9-28.userapi.com/impg/E4Zo24q6HyAv-9bmDE0jTlt7WWfix5rwgevgSA/ziCso9i-xOw.jpg?size=1920x1080&quality=95&sign=2517250eeb62103667ba42ad6247ee5e&type=album)

![dashboard_3](https://sun9-15.userapi.com/impg/AgZgYP8OtF9tiH1Diu-v0mXhz4_sFZmpCxs7dg/kZaJwMd72L8.jpg?size=1920x1080&quality=95&sign=f5d599e65cb81b800ddd77617e0beee8&type=album)

**Ссылка на дашборд: [dashboard_link](http://178.20.45.3:3000/d/fc37bc23-fcbc-4970-a08e-b2ccf073f920/app?orgId=1&from=now-15m&to=now&refresh=5s)**

**Логин: admin**

**Пароль: 2212**

**Адрес приложения: http://178.20.45.3:8000/**

**Нагрузка пользователей: `docker run --rm --network=host -e "SERVER_ADDR=178.20.45.3:8000" skinass/edu-vk-client /usr/local/bin/client`**